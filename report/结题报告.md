# 扑克牌游戏项目设计说明

## 一、需求分析

我们希望实现一个直观的，易上手的扑克游戏，将 windows 上的游戏“红心大战”作为参考对象，具体需求大致如下：

- 直观的 GUI 界面，用于与用户的交互，能显示4人的手牌与出牌情况，各玩家的状态（是否托管）
- 两种纸牌游戏的规则实现，能检查出牌是否合法
- 纸牌游戏的 AI 实现，用于托管或直接作为填充人数的方式
- 网络模块，用于局域网联机，应当保证传输质量，支持错误检测
- 统筹各模块的核心 API

## 二、总体设计

## 三、系统模块说明

### 逻辑模块

### 网络模块

#### 基本介绍

- 网络模块使用 winsock2 作为底层实现，对其进行进一步封装和抽象，最终实现了一个具有一定错误处理，功能定制能力的网络库。

#### 继承关系

- 网络模块继承关系如下

![image-20200703092924762](.\img\image-20200703092924762.png)

#### 核心类说明：

- 各Socket类：对 winsock 的封装，包含建立连接，收发消息，设置socket状态（阻塞、非阻塞）等功能。
- Broadcaster：UDP 广播的收发，负责发现服务器。
- DataStream：对 DataSocket 的进一步封装，用于收发带分隔消息与处理MTU限制带来的包分割，`sendLine(W)` 与 `getLine(W)` 是两个版本，分别接受 ascii 字符和 UTF16 字符。
- Client：对客户端处理服务端连接功能的封装，包括心跳，关闭连接等指令的处理，使用 `handleMessage`处理服务端信息。
- Server：对建立服务端功能的封装，包括广播与接收连接。
- Worker：对服务端处理客户端连接功能的封装，包括心跳，关闭连接等。

### AI 模块

#### 基本介绍

- AI模块实现了3人争上游和4人红心大战的AI。

#### 继承关系

- AI模块设计了Type类表示争上游游戏中可能出现的各种牌型，下有One, Two, Three, Four, Four_Two, Three_Two, Dragon, Rocket, Plane派生类。

#### 核心类说明

- rank:一次出牌的相对大小，以这些牌中最小的牌为基准。
- type:表示该次出牌的类型。
- play_card:得到这些牌在手牌中的ID。
- impossible_better：剩余的牌是否能管上，1表示不能管上，0表示有炸弹能管上，-1表示没有炸弹也能管上。
- check_type：检查两个顺子的宽度是否相同（如单顺宽度是1，双顺宽度是2，它们之间不能互相压制）
- getlast:检查这些牌中最大的牌。
- getother:得到这些牌中无实际意义的牌的大小（如三带二的对子）
- getlength：得到顺子的长度。

### 界面模块

## 四、系统设计难点与解决

### 逻辑模块

### 网络模块

- winsock2 的文档不是很完善，而且缺少例子，需要在 stack overflow 上慢慢摸索。
- 网络程序难以调试，在本机测试正常的功能在生产环境中仍然出现问题。经过与 API 负责人的漫长联合调试解决问题。
- 为了保证间接性与安全性，整个网络模块没有使用多线程。但是 c++ 缺少对单线程异步的语法工具，只能自己用一个计时器模拟，在具体使用中用轮询处理。

### AI 模块


### 界面模块

## 五、总结

### 逻辑模块

### 网络模块

- 对于一个模块而言，一开始明确具体的调用结构非常重要。实际实现中我选择了先给发出所有函数声明与引用关系，最后给出实现，大大减少了重构的次数。
- 善用命名空间和宏可以很好地整理代码。

### AI 模块


### 界面模块

## 附录一、程序使用说明

## 附录二、系统开发日志
